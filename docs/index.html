<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>VoiceTombola</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="screen-size" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="screen-size" content="width=device-height,initial-scale=1,user-scalable=no">
  <!-- PWA Meta Tags -->
  <meta name="description" content="App tombola con riconoscimento vocale e smorfia napoletana/generica">
  <meta name="theme-color" content="#007bff">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="VoiceTombola">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/png" href="tombola.png">
  <link rel="apple-touch-icon" href="tombola.png">

  <style>
    /* Reset e stili base per app mobile */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0;
      background-color: #000; color: #fff; min-height: 100vh; min-height: -webkit-fill-available;
      display: flex; flex-direction: column; position: fixed; width: 100%; overflow: hidden; }
    .app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background-color: #1a1a1a;
      display: flex; align-items: center; justify-content: center; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .app-header h1 { font-size: 20px; font-weight: 600; color: #fff; }
    .app-content { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; padding: 1px 1px 60px; position: relative; width: 100%; }
    .status-bar { background-color: #007bff; color: white; padding: 1px 16px; font-size: 12px; text-align: center; position: relative; }
    .number-card { background-color: #1a1a1a; border-radius: 16px; padding: 1px; margin: 16px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    #numero { font-size: 24px; font-weight: 700; color: #fff; text-align: center; margin-bottom: 16px; line-height: 1.4; text-shadow: 0 0 20px rgba(0,123,255,0.6); }
    #frase { font-size: 24px; color: #fff; text-align: center; margin-top: 12px; line-height: 1.4; padding: 0 10px; }
    .app-description { text-align: center; margin: 12px 16px; font-size: 16px; line-height: 1.4; color: #fff; opacity: 0.9; padding: 1px; background-color: rgba(0,0,0,0.2); border-radius: 8px; }
    .bottom-toolbar { position: fixed; text-align: center; bottom: 0; left: 0; right: 0; width: 100%; background-color: #1a1a1a; padding: 8px 16px; box-shadow: 0 -2px 4px rgba(0,0,0,0.1); z-index: 100; }
    .controls-container { display: flex; flex-direction: row; justify-content: center; align-items: center; gap: 8px; width: 100%; max-width: 600px; margin: 0 auto; }
    button { font-size: 14px; font-weight: 600; padding: 12px 8px; width: 25%; background-color: #007bff; color: white; border: none; border-radius: 12px; margin: 0; touch-action: manipulation; -webkit-appearance: none; appearance: none; transition: background-color 0.2s; }
    button:active { background-color: #0056b3; }
    button.selected { background-color: #28a745; box-shadow: 0 0 10px rgba(40,167,69,0.5); }
    #btnStart { display: none !important; }
    #btnItaliano, #btnNapoletano { font-size: 18px; width: 32%; margin: 0; padding: 12px 4px; }
    #btnReset { background-color: #dc3545; font-size: 18px; width: 32%; margin: 0; padding: 12px 4px; }
    #btnReset:active { background-color: #c82333; }
    select { font-size: 17px; padding: 12px 36px 12px 16px; background-color: #2c2c2e; color: white; border: 1px solid #3a3a3c; border-radius: 12px; width: 100%; -webkit-appearance: none; appearance: none; background-repeat: no-repeat; background-position: right 12px center; background-size: 12px; padding-right: 30px; }
    img { max-width: min(300px, 80vw); height: auto; margin: 10px auto; display: block; }
    @media (min-width: 768px) { .controls-container { flex-direction: row; justify-content: center; flex-wrap: wrap; } button, select { margin: 5px 10px; } }
    @supports (-webkit-touch-callout: none) { body { min-height: -webkit-fill-available; } }
    .voice-controls { display: none !important; }
  </style>
</head>

<body>
  <!-- Header fisso -->
  <header class="app-header"><h1>VoiceTombola</h1></header>

  <main class="app-content">
    <div class="status-bar" id="authStatus">Premi Avvia per autorizzare microfono e audio</div>

    <div style="background-color: #007bff; padding: 0; border-radius: 16px; margin: 0px 16px; box-shadow: 0 4px 12px rgba(0,123,255,0.3); color:white; font-size: 20px; text-align: center; line-height: 2;">
      <br> L'app restituisce la smorfia (Gen/Nap)<br>del numero estratto e la riproduce<br>vocalmente. Per terminare dire "99"<br> per reset premere R;
    </div>

    <img decoding="async" src="tombola.png" width="280" height="280" alt="Tombola" style="padding:1px; display:block; margin:24px auto; width:280px; height:auto; max-width:90%;">

    <div class="number-card">
      <div id="numero">0</div>
      <div id="frase">VIA!</div>
    </div>
  </main>

  <div class="bottom-toolbar">
    <div class="controls-container">
      <button id="btnItaliano" onclick="selectMode('generico')">Generica</button>
      <button id="btnNapoletano" onclick="selectMode('napoletano')">Napoletana</button>
      <button id="btnReset" onclick="resetApp()">R</button>
    </div>
  </div>

  <audio id="bell" src="audio_door.mp3" preload="auto"></audio>

  <script>
    // Service worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then(r => console.log('SW registrato', r.scope))
          .catch(e => console.warn('SW fallito', e));
      });
    }

    // Globals
    let smorfiaType = 0;
    let authStatusEl, numeroEl, fraseEl, btnItaliano, btnNapoletano, voiceSelect, testVoiceBtn, bell;
    let listening = false;
    let stoppedByUser = false;
    let micStream = null;

    // Duplication protections & normalization
    let voicesLoaded = false;
    let _lastTranscript = "";
    let _lastTranscriptNormalized = "";
    let _lastTranscriptTime = 0;
    let _lastSpokenText = "";
    let _lastSpokenTime = 0;
    let speakingLock = false;
    const TRANSCRIPT_DEDUPE_MS = 900;
    const SPEAK_DEDUPE_MS = 1300;

    function normalizeTranscript(text) {
      if (!text) return "";
      let t = text.toLowerCase().trim();
      t = t.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
      t = t.replace(/[^0-9a-z\s]/g, ' ');
      t = t.replace(/\s+/g, ' ').trim();
      t = t.replace(/\bnovanta\s?nove\b/g, '99');
      return t;
    }

    // Init DOM refs
    document.addEventListener('DOMContentLoaded', () => {
      authStatusEl = document.getElementById('authStatus');
      numeroEl = document.getElementById('numero');
      fraseEl = document.getElementById('frase');
      btnItaliano = document.getElementById('btnItaliano');
      btnNapoletano = document.getElementById('btnNapoletano');
      voiceSelect = document.getElementById('voiceSelect');
      testVoiceBtn = document.getElementById('testVoice');
      bell = document.getElementById('bell');

      if (authStatusEl) authStatusEl.textContent = 'Seleziona una modalità (Generica o Napoletana) per iniziare';
      if (window.requestMicPermission) {
        window.requestMicPermission().then(granted => {
          if (window.updateAuthStatus) window.updateAuthStatus(granted);
        });
      }
    });

    // Smorfie
    const smorfiaNapoletana = {
      1:"Italia",2:"a criatura",3:"a jatta",4:"o puorco",5:"a mano",6:"chella che guarda en terra",
      7:"a scupetta",8:"a Maronna",9:"a figliata",10:"e fasule",11:"e surice",12:"o surdato",
      13:"Sant'Antonio",14:"o imbriàco",15:"o guaglione",16:"o culo",17:"a disgrazia",18:"o sanghe",
      19:"a resata",20:"a festa",21:"a femmena annura",22:"o pazzo",23:"o scemo",24:"e gguardie",
      25:"Natale",26:"Nanninella",27:"o cantaro",28:"e zizze",29:"o pate de criature",30:"e palle do tenente",
      31:"o padrone e casa",32:"o capitone",33:"lanne e Cristo",34:"a capa",35:"laucielluzzo",36:"e castagnelle",
      37:"o monaco",38:"e mazzate",39:"a funa nganna",40:"a paposcia",41:"o curtiello",42:"o café",
      43:"a femmena ncopp’o balcone",44:"e cancelle",45:"o vino",46:"e denare",47:"o muorto",48:"o muorto che parla",
      49:"o piezzo e carne",50:"o pane",51:"o ciardino",52:"a mamma",53:"o viecchio",54:"o cappiello",
      55:"a museca",56:"a caruta",57:"o scartellato",58:"o paccotto",59:"e pile",60:"o lamento",
      61:"o cacciatore",62:"o muorto acciso",63:"a sposa",64:"a sciammeria",65:"o chianto",66:"e doie zitelle",
      67:"o totano inta chitarra",68:"a zuppa cotta",69:"sottencoppa",70:"o palazzo",71:"l’ommo e niente",
      72:"a meraviglia",73:"o spitale",74:"a rotta",75:"Pullecenella",76:"a Funtana",77:"e diavole",
      78:"a bella figliola",79:"o mariuolo",80:"a vocca",81:"e sciure",82:"a tavula imbandita",83:"o malotiempo",
      84:"a chiesa",85:"anime ro priatorio",86:"a puteca",87:"e perucchie",88:"e casecavalle",89:"a vecchia",90:"a paura"
    };
    const smorfiaGenerica = {
      1:"Italia",2:"la bambina",3:"il gatto",4:"il maiale",5:"la mano",6:"guarda sempre a terra",
      7:"il Vaso",8:"la Madonna",9:"la figliolanza",10:"i fagioli",11:"i topolini",12:"il militare",
      13:"Sant'Antonio",14:"l'ubriaco",15:"il ragazzo",16:"il deretano",17:"la sfortuna",18:"il sangue",
      19:"la risata",20:"la festa",21:"la femmina nuda",22:"il pazzo",23:"lo scemo",24:"la polizia",
      25:"Natale",26:"Sant'Anna",27:"il vaso da notte",28:"il seno",29:"il padre di tutti i bambini",
      30:"le palle del capitano",31:"l'uomo ricco",32:"il capitone",33:"gli anni di Cristo",34:"la testa",
      35:"gli uccellini",36:"le Nacchere",37:"il Monaco",38:"le bastonate",39:"l'impiccato",40:"la noia",
      41:"il coltello",42:"il Caffè",43:"la donna pettegola",44:"il carcere",45:"il vino buono",46:"i denari",
      47:"il morto",48:"il morto che parla",49:"un pezzo di carne",50:"il pane",51:"il giardino",52:"la mamma",
      53:"il vecchio",54:"il cappello",55:"la musica",56:"la Caduta",57:"il Gobbo",58:"l'imbroglio",
      59:"i peli",60:"il lamento",61:"il cacciatore",62:"il morto ammazzato",63:"la sposa",64:"la Marsina",
      65:"il pianto",66:"le due sorelle",67:"il polpo nella chitarra",68:"la zuppa cotta",69:"sottosopra",
      70:"il palazzo",71:"un uomo malvagio",72:"la meraviglia",73:"l'ospedale",74:"la Grotta di Gesù",
      75:"Pulcinella",76:"la Fontana",77:"i diavoli",78:"la prostituta",79:"il ladro",80:"la bocca",
      81:"i fiori",82:"la tavola imbandita",83:"il temporale",84:"la Chiesa",85:"le Anime del Purgatorio",
      86:"la bottega",87:"i pidocchi",88:"cacio cavalli",89:"la vecchia",90:"la paura"
    };

    function getSmorfia() { return smorfiaType === 0 ? smorfiaNapoletana : smorfiaGenerica; }

    // SpeechSynthesis helpers
    const synth = window.speechSynthesis;
    synth.addEventListener && synth.addEventListener('voiceschanged', () => {
      try { console.log('Voices disponibili:', (synth.getVoices()||[]).map(v=>`${v.name}(${v.lang})`)); } catch(e){/*ignore*/}
    });

    function selectFemaleVoice() {
      const voices = synth.getVoices() || [];
      if (!voices.length) return null;
      try {
        const saved = localStorage.getItem('preferredVoiceName');
        if (saved) {
          const found = voices.find(v => v.name === saved);
          if (found) return found;
        }
      } catch(e){}
      const preferredNames = ["Microsoft Elsa Online (Natural)","Microsoft Elsa","Elsa","Microsoft Elsa Online"];
      for (const n of preferredNames) {
        const v = voices.find(x => x.name === n);
        if (v) return v;
      }
      const elsaLoose = voices.find(v => /Elsa/i.test(v.name));
      if (elsaLoose) return elsaLoose;
      const italianNamed = voices.find(v => /isabella|anna|silvia|giorgia|maria/i.test(v.name));
      if (italianNamed) return italianNamed;
      const italian = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith('it'));
      if (italian.length) {
        const femaleCandidate = italian.find(v => /female|femmina|donna|soprano|voce|voice/i.test(v.name));
        return femaleCandidate || italian[0];
      }
      const globalFemale = voices.find(v => /female|femmina|donna|woman|girl/i.test(v.name));
      return globalFemale || voices[0] || null;
    }

    function populateVoiceList() {
      try {
        const voices = synth.getVoices() || [];
        if (!voiceSelect) return;
        voiceSelect.innerHTML = '';
        voices.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.name;
          opt.textContent = `${v.name} (${v.lang})${v.default ? ' — default' : ''}`;
          voiceSelect.appendChild(opt);
        });
        const saved = localStorage.getItem('preferredVoiceName');
        if (saved) {
          const match = Array.from(voiceSelect.options).find(o => o.value === saved);
          if (match) match.selected = true;
        }
      } catch(e){}
    }
    if (synth.onvoiceschanged !== undefined) {
      synth.addEventListener('voiceschanged', () => {
        populateVoiceList();
        if (!localStorage.getItem('preferredVoiceName')) {
          const voices = synth.getVoices() || [];
          const elsa = voices.find(v => /Elsa/i.test(v.name));
          if (elsa && voiceSelect) { voiceSelect.value = elsa.name; localStorage.setItem('preferredVoiceName', elsa.name); }
        }
      });
    }
    setTimeout(populateVoiceList, 0);
    setTimeout(() => {
      if (voiceSelect) {
        voiceSelect.addEventListener('change', () => {
          try { localStorage.setItem('preferredVoiceName', voiceSelect.value); } catch(e){}
        });
      }
      if (testVoiceBtn) {
        testVoiceBtn.addEventListener('click', () => {
          const testo = 'Questa è una prova della voce selezionata.';
          const u = new SpeechSynthesisUtterance(testo);
          u.lang = 'it-IT';
          const v = (synth.getVoices() || []).find(x => x.name === (voiceSelect ? voiceSelect.value : ''));
          if (v) u.voice = v;
          synth.speak(u);
        });
      }
    }, 100);

    // Robust parla()
    function parla(testo) {
      try {
        if (!testo) return;
        const now = Date.now();
        const testoNorm = (testo||'').toString().trim();
        if (testoNorm === _lastSpokenText && (now - _lastSpokenTime) < SPEAK_DEDUPE_MS) {
          console.log('parla: SKIP dedup time:', testoNorm); return;
        }
        if (speakingLock && testoNorm === _lastSpokenText) { console.log('parla: SKIP speakingLock for same text'); return; }
        _lastSpokenText = testoNorm; _lastSpokenTime = now;
        const u = new SpeechSynthesisUtterance(testo);
        u.lang = 'it-IT';
        u.onstart = () => { speakingLock = true; console.log('utterance onstart:', testoNorm); };
        u.onend = () => { setTimeout(()=>{ speakingLock = false; console.log('utterance onend, lock released:', testoNorm); }, 60); };
        u.onerror = (e)=>{ speakingLock = false; console.warn('utterance onerror', e); };
        const doSpeak = () => {
          const v = selectFemaleVoice();
          if (v) u.voice = v;
          try { window.speechSynthesis.cancel(); } catch(e){}
          try { window.speechSynthesis.speak(u); console.log('synth.speak called:', testoNorm); } catch(e){ console.warn('speak err', e); speakingLock=false; }
        };
        if (!window.speechSynthesis.getVoices || window.speechSynthesis.getVoices().length === 0) {
          if (!voicesLoaded) {
            voicesLoaded = true;
            window.speechSynthesis.addEventListener('voiceschanged', () => { try { doSpeak(); } catch(e){console.warn(e);} }, { once: true });
          } else setTimeout(doSpeak, 30);
        } else doSpeak();
      } catch (err) { console.error('Errore in parla():', err); }
    }

    // Speech Recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
      document.addEventListener('DOMContentLoaded', () => {
        if (fraseEl) fraseEl.textContent = "SpeechRecognition non supportato nel tuo browser";
      });
    } else {
      const recognition = new SpeechRecognition();
      recognition.lang = "it-IT";
      recognition.interimResults = false;
      recognition.continuous = true;
      recognition.maxAlternatives = 1;

      function aggiorna(numero, frase) {
        if (numeroEl) numeroEl.textContent = numero ?? 0;
        if (fraseEl) fraseEl.textContent = frase || "";
      }

      recognition.onresult = (e) => {
        try {
          const lastRes = e.results[e.results.length - 1][0];
          const dettoRaw = (lastRes.transcript || '').trim();
          const dettoNorm = normalizeTranscript(dettoRaw);
          const now = Date.now();
          console.log('recognition.onresult raw:', dettoRaw, 'norm:', dettoNorm, 'confidence:', lastRes.confidence);
          if (dettoNorm && dettoNorm === _lastTranscriptNormalized && (now - _lastTranscriptTime) < TRANSCRIPT_DEDUPE_MS) {
            console.log('recognition.onresult: SKIP duplicate normalized transcript:', dettoNorm); return;
          }
          _lastTranscript = dettoRaw; _lastTranscriptNormalized = dettoNorm; _lastTranscriptTime = now;
          let numero = parseInt(dettoRaw.replace(/[^\d]/g,''), 10);
          if (isNaN(numero)) {
            if (/^\d+$/.test(dettoNorm)) numero = parseInt(dettoNorm,10); else numero = NaN;
          }
          let frase = "";
          if (!isNaN(numero)) {
            if (numero === 99) {
              frase = "Grazie per aver giocato! Arrivederci.";
              aggiorna(numero, frase); parla(frase); stoppedByUser = true; recognition.stop();
              document.body.innerHTML = "<h2 style='text-align:center;margin-top:40vh;'>Chiusura VoiceTombola</h2>";
              return;
            }
            if (numero > 90) frase = " ";
            else { const sm = getSmorfia(); frase = sm[numero] || `Numero ${numero}`; console.log(`Numero riconosciuto: ${numero} => ${frase}`); }
          } else frase = " ";
          aggiorna(numero || 0, frase);
          if (frase.trim() !== "") parla(frase);
        } catch (err) { console.error('Errore in recognition.onresult:', err); }
      };

      recognition.onerror = (ev) => {
        console.warn("recognition.onerror", ev.error);
        listening = false;
        if (ev.error === 'no-speech' || ev.error === 'audio-capture' || ev.error === 'aborted') return;
        if (ev.error === 'not-allowed') { if (authStatusEl) authStatusEl.textContent = 'Microfono negato. Consenti nelle impostazioni del browser.'; stoppedByUser = true; }
        else { if (authStatusEl) authStatusEl.textContent = `Errore: ${ev.error}. Premi Reset per riavviare.`; }
      };

      recognition.onend = () => {
        listening = false;
        console.log("Recognition.onend - stoppedByUser:", stoppedByUser);
        if (!stoppedByUser) {
          setTimeout(() => {
            if (!stoppedByUser) {
              try { recognition.start(); listening = true; console.log("Recognition riavviato automaticamente"); } catch (err) { console.warn("Impossibile riavviare recognition", err); if (authStatusEl) authStatusEl.textContent = 'Microfono interrotto. Premi Reset per riavviare.'; }
            }
          }, 700);
        } else {
          if (authStatusEl) authStatusEl.textContent = 'Microfono spento. Seleziona una modalità per riavviare.';
        }
      };

      async function requestMicPermission() {
        try {
          if (micStream) return true;
          const savedPermission = localStorage.getItem('micPermissionGranted');
          if (savedPermission === 'true') return true;
          micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
          localStorage.setItem('micPermissionGranted', 'true');
          return true;
        } catch (e) { console.warn('Errore accesso microfono:', e); return false; }
      }

      function updateAuthStatus(granted) {
        try { if (granted) { if (authStatusEl) authStatusEl.textContent = 'Seleziona una modalità (Generica o Napoletana) per iniziare'; } else { if (authStatusEl) authStatusEl.textContent = 'Errore: microfono non autorizzato. Ricarica la pagina e riprova.'; } } catch(e){}
      }

      async function startListening() {
        if (listening) { console.log("Recognition già attivo"); return; }
        try {
          const hasPermission = await requestMicPermission();
          if (!hasPermission) { if (authStatusEl) authStatusEl.textContent = 'Errore: microfono non autorizzato. Ricarica la pagina e riprova.'; return; }
          stoppedByUser = false;
          recognition.start();
          listening = true;
          console.log("Recognition avviato");
          if (authStatusEl) authStatusEl.textContent = 'Ascolto attivo... Di\' un numero o "novantanove" per terminare.';
        } catch (err) { console.warn("Errore start recognition", err); if (authStatusEl) authStatusEl.textContent = 'Errore avvio riconoscimento. Usa Reset e riprova.'; }
      }

      function stopListening() { stoppedByUser = true; try { recognition.stop(); } catch(e){} }

      window.startListening = startListening;
      window.stopListening = stopListening;
      window.requestMicPermission = requestMicPermission;
      window.updateAuthStatus = updateAuthStatus;
    }
  </script>
</body>
</html>